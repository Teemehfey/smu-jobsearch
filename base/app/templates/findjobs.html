<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Find Jobs</title>

    <!-- Bootstrap core CSS -->
    <link href="{{url_for('static',filename='vendor/bootstrap/css/bootstrap.min.css')}}" rel="stylesheet">

    <!-- Jquery -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>


    <!-- Custom styles for this template -->
    <link href="{{url_for('static',filename='css/styles.css')}}" rel="stylesheet">
    <link href="{{url_for('static',filename='css/animate.css')}}" rel="stylesheet">

  </head>

  <body class="index-reg-bg">


    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#" style="padding-top: 10px;padding-right:25px;"><img src="{{url_for('static',filename='img/$MU.png')}}" width="auto" height="30" alt=""></a>
        <a class="navbar-brand" style="color:#fff; padding-bottom: 3px;">Welcome,</a><a class="navbar-brand" href="{{ url_for('myprofile',id=current_user.id)}}"><i><u>{{current_user.email}}</u></i></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
          <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Menu
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
              <h3 class="nav-link dropdown-header text-info">Jobs</h3>
                <a class="nav-link dropdown-item text-secondary" href="{{ url_for('index_reg') }}">Featured Jobs</a>
                <a class="nav-link dropdown-item text-secondary" href="{{ url_for('findjobs') }}">Find Jobs</a>
                <a class="nav-link dropdown-item text-secondary" href="{{ url_for('myjobs')}}">My Jobs</a>
                <a class="nav-link dropdown-item text-secondary" href="{{ url_for('myjobs')}}">More Jobs</a>
              <h3 class="nav-link dropdown-header text-info">Profile</h3>
                <a class="nav-link dropdown-item text-secondary" href="{{ url_for('myprofile', id=current_user.id)}}">My Profile</a>
                <a class="nav-link dropdown-item text-secondary" href="{{ url_for('myfeedback')}}">My Feedback</a>
                <a class="nav-link dropdown-item text-secondary" href="{{ url_for('logout') }}">Logout</a>
            </div>
          </div>
         </ul>
        </div>
      </div>
    </nav>

    <!-- Page Content -->
   <div class="container">
     <br><br><br><br><br>


     <div id="main">
       <div class='card-column'>
       <h1 style="text-align:center">Find Jobs</h1>
       <br>

       <div class="d-flex justify-content-center">

           <form method='post' class='form-inline'>
             {{ form.hidden_tag() }}

             <div class="form-group mx-sm-3 mb-2">
             {{ form.keyword(size=100, class_="form-control", placeholder="Search job-related keywords, separated by comma (e.g. Python, Tableau, Developer)") }}
           </div>
             {{ form.submit(class_='btn btn-danger mb-2') }}


           </form>
       </div>
     </div>
 <br>
     {% if querystatus == 'success' %}
     <div class="alert alert-success" role="alert">
       Your search returned {{ count }} result(s).
     </div>
     {% elif querystatus == 'length' %}
     <div class="alert alert-danger" role="alert">
       Your search is too short.
     </div>
     {% elif querystatus == 'noresult' %}
     <div class="alert alert-info" role="alert">
       Your search returned no results.
     </div>
     {% endif %}
     </div>


       <!-- <br> -->


       {% if querystatus == 'success' or querystatus == 'no query' %}
       <div id='allCards' class="card-column">
     {% for job in queried_jobs %}
       <div class="card animated fadeInUp cardCount">
         <div class="card-body">
           <h5 class="card-title">{{ job.title }} - {{ job.organization }}</h5>

           <p class="card-text"><small class="text-muted">Posted on {{ job.timestamp.strftime('%Y-%m-%d') }} by {{ job.email }}</small></p>
             <a href="{{ url_for('applyjob', id=job.id) }}"><button type="button" class="btn btn-dark">View</button></a>
         </div>
       </div>
       <br>
     {% endfor %}
   </div>
   {% endif %}

   <div id='result' style='text-align:center'></div><br>
   <button onclick='loadMore()' type='button' class='btn btn-block btn-light'>Load More</button>

       <br><br>
       </div>
   </div>
   <!-- /.container -->
    <script>

        function loadMore(keywords,manyMore,count) {

          var result = document.getElementById("result");
          var keywords = {{ kw|safe}}
          var listingCount = $('.cardCount').length;
          console.log(listingCount);

          var data = {'keywords':keywords,'listingCount':listingCount}
          var csrf_token = "{{ csrf_token() }}";

          if (listingCount >= 5) {
          $.ajaxSetup({
              beforeSend: function(xhr, settings) {
                  if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                      xhr.setRequestHeader("X-CSRFToken", csrf_token);
                  }
              }
          });

          $.ajax({
          type: "POST",
          url: "/findjobs/ajax",
          data: JSON.stringify(data),
          contentType: "application/json; charset=utf-8", // this
          dataType: "json", // and this
          success: function (msg) {
             console.log('success')
             // console.log(msg['data']);
             var data = msg['data'];
             console.log(msg['data'])
             if (data.length > 0) {
             for (i=0; i<data.length; i++) {
               console.log(data[i])
               var id = data[i][0]
               var title = data[i][1]
               var organization = data[i][2]
               var postdate = data[i][3]
               var email=data[i][4]


               var combined1 = title + " - " + organization
               var combined2 = "Posted on " + postdate + " by " + email


               var div = document.createElement("div");
               div.innerHTML = "<div class='card animated fadeInUp cardCount'><div class='card-body'><h5 class'card-title'>"+combined1+"</h5><p class='card-text'><small class='text-muted'>"+combined2+"</small></p><a href='/applyjob/"+id+"'><button type='button' class='btn btn-dark'>View</button></a></div></div><br>";



                document.getElementById("allCards").appendChild(div);

             }
           } else {
             result.innerHTML = (
               "<br>That's all folks!"
             );
           }

            },
          error: function (errormessage) {
            console.log('failure')
          }
      });
    }
    else {
      result.innerHTML = (
        "<br>That's all folks!"
      );
    }
  }


    </script>


    <!-- Bootstrap core JavaScript -->
    <script src="{{url_for('static',filename='vendor/jquery/jquery.min.js')}}"></script>
    <script src="{{url_for('static',filename='vendor/bootstrap/js/bootstrap.bundle.min.js')}}"></script>

  </body>

</html>
